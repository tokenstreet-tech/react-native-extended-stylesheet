name: üöÄ Continuous deployment
on:
    push:
        branches:
            - main
    workflow_dispatch:
        inputs:
            version:
                description: "Version ['patch', 'minor', 'major']"
                required: true

env:
    NODE_VERSION: 18
    REGISTRY_URL: 'https://registry.npmjs.org'
    GIT_USER_NAME: tokenstreet-tools
    GIT_USER_EMAIL: tools@tokenstreet.com

jobs:
    deploy_website:
        name: üåê Deploy website
        runs-on: ubuntu-latest
        if: github.event_name == 'push'
        steps:
            - name: üõë Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.11.0
            - name: ‚¨áÔ∏è Checkout repo
              uses: actions/checkout@v3
            - name: ‚éî Setup node
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  registry-url: ${{ env.REGISTRY_URL }}
            - name: üì• Download deps
              uses: bahmutov/npm-install@v1
            - name: Deploy to GitHub Pages
              uses: peaceiris/actions-gh-pages@v3
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  publish_dir: ./packages/website/build
                  user_name: ${{ env.GIT_USER_NAME }}
                  user_email: ${{ env.GIT_USER_EMAIL }}
    publish_package:
        name: ‚¨ÜÔ∏è Publish package
        runs-on: ubuntu-latest
        if: github.event_name == 'workflow_dispatch'
        steps:
            - name: üõë Cancel Previous Runs
              uses: styfle/cancel-workflow-action@0.11.0
            - name: ‚¨áÔ∏è Checkout repo
              uses: actions/checkout@v3
              with:
                  token: ${{ secrets.PERSONAL_ACCESS_TOKEN_TOOLS_TOKENSTREET }}
            - name: Set git credentials
              run: |
                  git config --global user.name "${{ env.GIT_USER_NAME }}"
                  git config --global user.email "${{ env.GIT_USER_EMAIL }}"
            - name: ‚éî Setup node
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  registry-url: ${{ env.REGISTRY_URL }}
            - name: üì• Download deps
              uses: bahmutov/npm-install@v1
            - run: yarn version --${{ github.event.inputs.version }}
              working-directory: ./packages/core
            - run: git push --follow-tags
            - run: yarn publish
              working-directory: ./packages/core
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
